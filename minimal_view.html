<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Self Portrait</title>
<style>
  body {
    background: white;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    font-family: sans-serif;
  }
  img {
    max-width: 95vw;
    max-height: 80vh;
    object-fit: contain;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 1rem;
    border: none;
    background: black;
    color: white;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover {
    background: #333;
  }

  /* ğŸª ê±°ìš¸ ë°˜ì‚¬ ë¡œë”© */
  .mirror-loader {
    position: relative;
    width: 60px;
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 12px;
  }
  .mirror-loader span {
    position: absolute;
    width: 8px;
    height: 8px;
    background: black;
    top: 50%;
    left: 50%;
    transform-origin: 0 0;
    border-radius: 2px;
    animation: mirrorAnim 1.2s ease-in-out infinite;
  }
  .mirror-loader span:nth-child(1) { transform: rotate(0deg); animation-delay: 0s; }
  .mirror-loader span:nth-child(2) { transform: rotate(45deg); animation-delay: 0.1s; }
  .mirror-loader span:nth-child(3) { transform: rotate(90deg); animation-delay: 0.2s; }
  .mirror-loader span:nth-child(4) { transform: rotate(135deg); animation-delay: 0.3s; }
  .mirror-loader span:nth-child(5) { transform: rotate(180deg); animation-delay: 0.4s; }
  .mirror-loader span:nth-child(6) { transform: rotate(225deg); animation-delay: 0.5s; }
  .mirror-loader span:nth-child(7) { transform: rotate(270deg); animation-delay: 0.6s; }
  .mirror-loader span:nth-child(8) { transform: rotate(315deg); animation-delay: 0.7s; }

  @keyframes mirrorAnim {
    0%, 100% {
      transform: scale(1);
      opacity: 0.3;
    }
    50% {
      transform: scale(1.6);
      opacity: 1;
    }
  }
</style>
</head>
<body>
  <img id="art" src="" alt="Artwork">
  <button id="saveBtn">ì´ë¯¸ì§€ ì €ì¥í•˜ê¸°</button>

  <script defer>
    const params = new URLSearchParams(window.location.search);
    const imgUrl = params.get('img');
    const art = document.getElementById('art');
    const saveBtn = document.getElementById('saveBtn');

    // ì´ˆê¸° ìˆ¨ê¹€
    art.style.display = "none";
    saveBtn.style.display = "none";

    // ë¡œë”© ì»¨í…Œì´ë„ˆ êµ¬ì„±
    const loadingContainer = document.createElement('div');
    loadingContainer.style.display = "flex";
    loadingContainer.style.flexDirection = "column";
    loadingContainer.style.alignItems = "center";
    loadingContainer.style.justifyContent = "center";
    loadingContainer.style.height = "100vh";
    loadingContainer.style.color = "#444";
    loadingContainer.style.fontSize = "1.1rem";
    loadingContainer.style.textAlign = "center";
    loadingContainer.style.gap = "14px";

    // ğŸª ê±°ìš¸ ë°˜ì‚¬í˜• ë¡œë”© ì¶”ê°€
    const mirrorLoader = document.createElement('div');
    mirrorLoader.className = "mirror-loader";
    for (let i = 0; i < 8; i++) {
      const span = document.createElement('span');
      mirrorLoader.appendChild(span);
    }

    const text = document.createElement('p');
    text.textContent = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)";
    text.style.margin = "0";

    loadingContainer.appendChild(mirrorLoader);
    loadingContainer.appendChild(text);
    document.body.insertBefore(loadingContainer, saveBtn);

    // ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§
    if (imgUrl) {
      const finalUrl = imgUrl.startsWith("http") ? imgUrl : "images/" + imgUrl;

      fetch(finalUrl, { method: "HEAD", cache: "no-store" })
        .then(res => {
          if (res.ok) {
            startLoadingSequence(finalUrl);
          } else {
            showDeletedMessage();
          }
        })
        .catch(showDeletedMessage);
    } else {
      showDeletedMessage();
    }

    function startLoadingSequence(finalUrl) {
      setTimeout(() => {
        art.src = finalUrl + "?t=" + new Date().getTime();
        art.onload = () => {
          loadingContainer.remove();
          art.style.display = "block";
          saveBtn.style.display = "block";
        };
        art.onerror = showDeletedMessage;
      }, 30000);
    }

    function showDeletedMessage() {
      loadingContainer.innerHTML = "";
      const msg = document.createElement('p');
      msg.textContent = "ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      msg.style.fontSize = "1.1rem";
      msg.style.color = "#444";
      msg.style.textAlign = "center";
      msg.style.margin = "0";
      loadingContainer.appendChild(msg);
    }

    saveBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = art.src;
      link.download = 'selfportrait.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
