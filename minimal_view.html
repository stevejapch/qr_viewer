<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Self Portrait</title>
<style>
  body {
    background: white;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    font-family: sans-serif;
  }
  img {
    max-width: 95vw;
    max-height: 80vh;
    object-fit: contain;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 1rem;
    border: none;
    background: black;
    color: white;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover {
    background: #333;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>
  <img id="art" src="" alt="Artwork">
  <button id="saveBtn">이미지 저장하기</button>

  <script defer>
  const params = new URLSearchParams(window.location.search);
  const imgUrl = params.get('img');
  const art = document.getElementById('art');
  const saveBtn = document.getElementById('saveBtn');

  // 초기 상태 숨기기
  art.style.display = "none";
  saveBtn.style.display = "none";

  // 로딩 UI 구성
  const loadingContainer = document.createElement('div');
  loadingContainer.style.display = "flex";
  loadingContainer.style.flexDirection = "column";
  loadingContainer.style.alignItems = "center";
  loadingContainer.style.marginTop = "15vh";
  loadingContainer.style.color = "#444";
  loadingContainer.style.fontSize = "1.1rem";
  loadingContainer.style.gap = "12px";

  const spinner = document.createElement('div');
  spinner.style.border = "6px solid #eee";
  spinner.style.borderTop = "6px solid black";
  spinner.style.borderRadius = "50%";
  spinner.style.width = "40px";
  spinner.style.height = "40px";
  spinner.style.animation = "spin 1s linear infinite";

  const text = document.createElement('p');
  text.textContent = "이미지 업로드 중입니다... (잠시만 기다려주세요)";

  loadingContainer.appendChild(spinner);
  loadingContainer.appendChild(text);
  document.body.insertBefore(loadingContainer, saveBtn);

  const style = document.createElement('style');
  style.innerHTML = `
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);

  // 캐시 키
  const cacheKey = "loaded_" + imgUrl;
  const deletedKey = "deleted_" + imgUrl;

  if (!imgUrl) {
    showDeletedMessage("이미지 URL이 없습니다.");
  } else {
    const finalUrl = imgUrl.startsWith("http") ? imgUrl : "images/" + imgUrl;

    // 이전에 삭제된 것으로 기록되어 있다면 바로 문구 표시
    if (localStorage.getItem(deletedKey) === "true") {
      showDeletedMessage("이미지가 삭제되었거나 존재하지 않습니다.");
      return;
    }

    // 이전에 로드된 이미지가 있다면 우선 존재 여부 확인
    if (localStorage.getItem(cacheKey) === "true") {
      checkIfImageStillExists(finalUrl, (exists) => {
        if (exists) {
          showImageImmediately(finalUrl);
        } else {
          localStorage.removeItem(cacheKey);
          localStorage.setItem(deletedKey, "true");
          showDeletedMessage("이미지가 삭제되었거나 존재하지 않습니다.");
        }
      });
    } else {
      startLoadingSequence(finalUrl);
    }
  }

  // ✅ 서버에 이미지 존재하는지 HEAD 요청으로 확인
  function checkIfImageStillExists(url, callback) {
    fetch(url, { method: "HEAD", cache: "no-store" })
      .then(res => callback(res.ok))
      .catch(() => callback(false));
  }

  // ✅ 처음 접속 시: 30초 기다리고 확인
  function startLoadingSequence(finalUrl) {
    setTimeout(() => {
      checkIfImageStillExists(finalUrl, (exists) => {
        if (exists) {
          showImageImmediately(finalUrl);
          localStorage.setItem(cacheKey, "true");
        } else {
          localStorage.setItem(deletedKey, "true");
          showDeletedMessage("이미지가 삭제되었거나 존재하지 않습니다.");
        }
      });
    }, 30000);
  }

  function showImageImmediately(finalUrl) {
    art.src = finalUrl + "?t=" + new Date().getTime();
    art.onload = () => {
      loadingContainer.remove();
      art.style.display = "block";
      saveBtn.style.display = "block";
    };
  }

  function showDeletedMessage(msg) {
    loadingContainer.innerHTML = "";
    const message = document.createElement('p');
    message.textContent = msg;
    message.style.fontSize = "1.1rem";
    message.style.color = "#444";
    message.style.margin = "0";
    message.style.textAlign = "center";
    loadingContainer.appendChild(message);
  }

  saveBtn.addEventListener('click', () => {
    const link = document.createElement('a');
    link.href = art.src;
    link.download = 'selfportrait.png';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
  </script>
</body>
</html>
